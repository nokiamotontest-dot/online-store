<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¸³ - å°å•†å“å•†åŸ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">ğŸª å°å•†å“å•†åŸ</a>
        </div>
        <div class="nav-links">
            <a href="index.html">é¦–é </a>
            <a href="products.html">å•†å“</a>
            <a href="cart.html">ğŸ›’ è³¼ç‰©è»Š</a>
        </div>
    </nav>

    <main class="main-content">
        <h2>ğŸ“ çµå¸³</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- é€è²¨è³‡æ–™ -->
            <div class="checkout-section">
                <h3>ğŸ“¦ é€è²¨è³‡æ–™</h3>
                <form id="checkout-form" onsubmit="processCheckout(event)">
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="shipping-name" required value="${DB.currentUser?.name || ''}">
                    </div>
                    <div class="form-group">
                        <label>é›»è©± *</label>
                        <input type="tel" id="shipping-phone" required value="${DB.currentUser?.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>é€è²¨åœ°å€ *</label>
                        <textarea id="shipping-address" rows="3" required placeholder="è«‹è¼¸å…¥å®Œæ•´é€è²¨åœ°å€"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨» (é¸å¡«)</label>
                        <textarea id="shipping-note" rows="2" placeholder="ä¾‹å¦‚ï¼šé€è²¨æ™‚æ®µã€ç‰¹æ®Šè¦æ±‚"></textarea>
                    </div>
                    
                    <h3 style="margin-top: 2rem;">ğŸ’³ ä»˜æ¬¾æ–¹å¼</h3>
                    <div class="form-group">
                        <select id="payment-method" required>
                            <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                            <option value="bank_transfer">ğŸ¦ éŠ€è¡Œè½‰å¸³</option>
                            <option value="cod">ğŸ’µ è²¨åˆ°ä»˜æ¬¾</option>
                            <option value="pending">â³ ç¨å¾Œä»˜æ¬¾ (è¯çµ¡å®¢æœ)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">æäº¤è¨‚å–®</button>
                </form>
            </div>
            
            <!-- è¨‚å–®æ‘˜è¦ -->
            <div>
                <div class="checkout-section">
                    <h3>ğŸ“‹ è¨‚å–®æ‘˜è¦</h3>
                    <div id="checkout-items">
                        <!-- ç”± JavaScript è¼‰å…¥ -->
                    </div>
                </div>
                
                <div class="checkout-section" style="margin-top: 1rem;">
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>å°è¨ˆ</span>
                            <span id="checkout-subtotal">$0</span>
                        </div>
                        <div class="summary-row">
                            <span>é‹è²»</span>
                            <span id="checkout-shipping">$60</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>ç¸½è¨ˆ</span>
                            <span id="checkout-total">$0</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding: 1rem; background-color: #fef3c7; border-radius: var(--radius-md);">
                    <p style="color: #92400e; font-size: 0.875rem;">ğŸ’¡ æç¤ºï¼šè¨‚å–®æäº¤å¾Œï¼Œæˆ‘å€‘æœƒç™¼é€ç¢ºèªé›»éƒµåˆ°æ‚¨çš„éƒµç®±ã€‚</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 å°å•†å“å•†åŸ. All Rights Reserved.</p>
    </footer>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!DB.currentUser) {
                window.location.href = 'account.html?redirect=checkout.html';
                return;
            }
            
            renderCheckoutItems();
        });

        function renderCheckoutItems() {
            const items = getCartItems();
            const container = document.getElementById('checkout-items');
            
            if (items.length === 0) {
                window.location.href = 'products.html';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="cart-item" style="box-shadow: none; border-bottom: 1px solid var(--border-color);">
                    <div class="cart-item-image" style="width: 60px; height: 60px;">${item.product.image}</div>
                    <div class="cart-item-info">
                        <p class="cart-item-name">${item.product.name}</p>
                        <p>æ•¸é‡: ${item.quantity}</p>
                        <p class="cart-item-price">${formatPrice(item.product.price * item.quantity)}</p>
                    </div>
                </div>
            `).join('');
            
            const subtotal = calculateTotal();
            const shipping = subtotal >= 500 ? 0 : 60;
            const total = subtotal + shipping;
            
            document.getElementById('checkout-subtotal').textContent = formatPrice(subtotal);
            document.getElementById('checkout-shipping').textContent = shipping === 0 ? 'å…è²»' : formatPrice(shipping);
            document.getElementById('checkout-total').textContent = formatPrice(total);
        }

        function processCheckout(event) {
            event.preventDefault();
            
            const items = getCartItems();
            if (items.length === 0) {
                showNotification('è³¼ç‰©è»Šæ˜¯ç©ºçš„', 'warning');
                return;
            }
            
            const order = {
                userId: DB.currentUser.id,
                shipping: {
                    name: document.getElementById('shipping-name').value,
                    phone: document.getElementById('shipping-phone').value,
                    address: document.getElementById('shipping-address').value,
                    note: document.getElementById('shipping-note').value
                },
                paymentMethod: document.getElementById('payment-method').value,
                items: items.map(item => ({
                    productId: item.productId,
                    productName: item.product.name,
                    price: item.product.price,
                    quantity: item.quantity
                })),
                subtotal: calculateTotal(),
                shipping: calculateTotal() >= 500 ? 0 : 60,
                total: calculateTotal(),
                finalTotal: calculateTotal() + (calculateTotal() >= 500 ? 0 : 60),
                status: 'pending'
            };
            
            const orderId = DB.addOrder(order);
            DB.clearCart();
            showNotification('è¨‚å–®å·²æäº¤ï¼');
            window.location.href = `order-success.html?id=${orderId}`;
        }
    </script>
</body>
</html>
